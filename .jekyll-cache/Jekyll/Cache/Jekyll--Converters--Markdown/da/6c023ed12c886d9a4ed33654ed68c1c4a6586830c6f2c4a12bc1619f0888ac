I"u6<h1 id="botão-led">Botão LED</h1>

<p>Agora que sabemos como acionar uma saída digital, vamos fazer a leitura de uma entrada também digital, utilizando um botão pulsador (<em>push button</em>) para ligar um LED.</p>

<p>Toda construção de programa deve ser feita de forma incremental, iniciando com uma estrutura básica e agregando parte a parte do código até atingir o objetivo.</p>

<h2 id="objetivo">Objetivo</h2>

<p>Acionar um LED copiando o estado lógico de um botão.</p>

<!--more-->

<h2 id="circuito-hardware">Circuito (<em>Hardware</em>)</h2>

<p>O circuito para atender o objetivo possui um LED como elemento de saída e um botão pulsador como elemento de entrada.</p>

<p>Na saída temos uma saída configurada como fonte (<em>source</em>), como tratado em <a href="/ddp/2020/P0101-piscaLED">P0101 - Pisca LED</a>.</p>

<p>A entrada deve possuir um estado lógico bem definido, mas um botão pulsador não garante esse estado lógico, pois possui apenas dois contatos, podendo sua configuração ser normalmente aberto (NA) ou normalmente fechado(NF). Na Figura 1 é utilizado um botão pulsador NA, que é a configuração mais comum.</p>

<p>Para garantir o tal estado lógico bem definido, é montado um ramo com o botão e um resistor, geralmente com 10kΩ, ligados em série, entre o Vcc e o GND. No ponto de conexão entre esses dois componentes temos, em relação ao terra (<em>GND</em>), uma tensão que é a tensão do componente conectado ao terra. Este ponto é conectado ao pino do uC, assim a tensão no pino é a mesma tensão sobre o componente ligado ao terra.</p>

<p>As duas configurações possíves são mostradas na Figura 1(a) e 1(b), em que o botão está conectado ao Vcc e a outra em que o botão está conectado ao terra.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Figura 1(a): Resistor de <em>Pull-down</em></th>
      <th style="text-align: center">Figura 1(b): Resistor de <em>Pull-up</em></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="https://github.com/JoseWRPereira/ddp/blob/master//_posts/tUcPIC/imgP0102/P0102-botaoLED-pulldownres.gif?raw=true" alt="circuito" /></td>
      <td style="text-align: center"><img src="https://github.com/JoseWRPereira/ddp/blob/master//_posts/tUcPIC/imgP0102/P0102-botaoLED-pullupres.gif?raw=true" alt="circuito" /></td>
    </tr>
  </tbody>
</table>

<p>Na configuração <em>pull-down</em> o resistor está conectado ao terra, o que garante, quando o botão estiver aberto, o nível lógico 0 (terra/GND).</p>

<p>Ao pressionar o botão, ele fecha e conecta o ponto de conexão com o pino ao Vcc, aplicando o nível lógico 1 a ele.</p>

<p>Na configuração <em>pull-up</em> o resistor está conectado ao positivo da fonte, Vcc. O botão na condição de não acionado está com contato aberto, assim a tensão sobre ele é a tensão da fonte, nesse caso 5V, conforme a 2ª lei de Kirchhoff, garantindo o nível lógico 1.</p>

<p>Ao pressionar o botão, ele fecha, ligando o ponto de conexão com o pino do uC ao GND, aplicando o nível lógico 0 a ele.</p>

<p>A configuração com o resistor de <em>pull-down</em> é a que proporciona uma lógica direta a entrada do dado: botão pressionado.</p>

<h2 id="programa-firmware">Programa (<em>Firmware</em>)</h2>

<p>A Figura 2 mostra a árvore de diretórios do projeto em que são utilizados dois arquivos, sendo que o <code class="language-plaintext highlighter-rouge">main.c</code> possui o programa e o <code class="language-plaintext highlighter-rouge">config.h</code> as diretivas de configuração.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Figura 2: Árvore de diretório do projeto</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="https://github.com/JoseWRPereira/ddp/blob/master//_posts/tUcPIC/imgP0102/projectTree.jpg?raw=true" alt="circuito" /></td>
    </tr>
  </tbody>
</table>

<p>O arquivo de configuração deve ser incluído no <code class="language-plaintext highlighter-rouge">main.c</code> com o comando <code class="language-plaintext highlighter-rouge">#include "config.h"</code> logo no início do código.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef CONFIG_H
#define CONFIG_H
</span>
<span class="cp">#pragma config FOSC  = INTRC_NOCLKOUT   // Fonte de clock: oscilador interno
#pragma config WDTE  = OFF              // Desabilita WatchDog Timer 
#pragma config MCLRE = OFF              // Desab. Master Clear via pino
#pragma config LVP   = OFF              // Desab. gravação em baixa tensão
</span>
<span class="cp">#define _XTAL_FREQ     4000000          // Freq. clock interno: 4MHz(padrão)
</span>
<span class="cp">#endif
</span></code></pre></div></div>

<p>A separação das diretivas de compilação é interessante por facilitar o tratamento dessas configurações, no caso de mudanças ou mesmo na inclusão de outras diretivas. Esse arquivo pode ser copiado para os demais projetos.</p>

<p>Segue o código fonte do <code class="language-plaintext highlighter-rouge">main.c</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * File:   main.c
 * Author: josewrpereira
 *
 * Created on 23 de Setembro de 2019, 13:03
 * 
 * IDE:         MPLAB X IDE v3.15
 * Compiler:    XC8 v1.45
 * OS:          Deepin 15.11 X86_64
 * Kernel:      4.15.0-30deepin-generic
 * 
 * Objetivo: 
 *      Acionar um LED através do estado lógico de um botão
 * 
 * Pinos    |nº     |Conexão
 *  VDD     |11,32  | Alimentação (Vcc/+5V)
 *  VSS     |12,31  | Alimentação (GND/0V)
 *  RD0     |19     |LED (source)
 *  RD3     |22     |Botão
 */</span>


<span class="cp">#include &lt;xc.h&gt;                 // Inclui biblioteca padrão do compilador XC8 
</span>                                <span class="c1">// para microcontroladores Microchip.</span>
<span class="cp">#include "config.h"             // Inclui arq. de config. (biblioteca) local.
</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>                 <span class="c1">// Função principal = main.</span>
<span class="p">{</span>                               <span class="c1">// Início do bloco da função main.</span>
    <span class="n">PORTDbits</span><span class="p">.</span><span class="n">RD0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="c1">// Inicia RD0 com o valor 0.</span>
    <span class="n">TRISDbits</span><span class="p">.</span><span class="n">TRISD0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="c1">// Configura RD0 como Saída.</span>
    <span class="n">TRISDbits</span><span class="p">.</span><span class="n">TRISD3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       <span class="c1">// Configura RD3 como Entrada;</span>
                                <span class="c1">// Não precisa inicialização do valor do pino.</span>
    
    <span class="k">while</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>                  <span class="c1">// Laço de repetição infinito.</span>
    <span class="p">{</span>                           <span class="c1">// Inicio do laço de repetição.</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">PORTDbits</span><span class="p">.</span><span class="n">RD3</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span><span class="c1">// Condição: Se o botão estiver pressionado.</span>
            <span class="n">PORTDbits</span><span class="p">.</span><span class="n">RD0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// Liga RD0.</span>
        <span class="k">else</span>                    <span class="c1">// Senão.</span>
            <span class="n">PORTDbits</span><span class="p">.</span><span class="n">RD0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// Desliga RD0.</span>
    <span class="p">}</span>                           <span class="c1">// Fim do laço de repetição.</span>
    <span class="k">return</span><span class="p">;</span>                     <span class="c1">// Caracteriza main como uma função sem retorno.</span>
<span class="p">}</span>                               <span class="c1">// Fim do bloco da função main.</span>

</code></pre></div></div>

<h2 id="estrutura-do-programa">Estrutura do programa</h2>

<p>O programa presente no arquivo fonte <code class="language-plaintext highlighter-rouge">main.c</code> possui o seguinte arranjo:</p>
<ul>
  <li>Comentários;</li>
  <li>Inclusão de bibliotecas;</li>
  <li>Programa principal.</li>
</ul>

<h3 id="comentários">Comentários</h3>
<p>Os comentários estão descritos em <a href="/ddp/2020/P0101-piscaLED">P0101 - Pisca LED</a> e são semelhantes em todos os projetos aqui apresentados, assim serão omitidos para simplificar e focar no código que resolve o objetivo apresentado, mas é importante que você faça os comentários em todos os seus projetos.</p>

<h3 id="inclusão-de-bibliotecas">Inclusão de bibliotecas</h3>
<p>Note que além da biblioteca padrão <code class="language-plaintext highlighter-rouge">xc.h</code>, agora está incluído o arquivo de cabeçalho <code class="language-plaintext highlighter-rouge">config.h</code>, como já citado anteriormente.</p>

<h3 id="programa-principal">Programa principal</h3>

<p>O programa principal pode ser dividido em duas partes: configuração e laço de repetição.</p>

<p>O trecho de configuração no código inicializa o pino RD0 do PORTD com o valor zero, que é para iniciar com o LED desligado.</p>

<p>A linha seguinte configura o RD0 como saída, porque é o pino que aciona o LED.</p>

<p>Em seguida é configurado como entrada o pino RD3.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">PORTDbits</span><span class="p">.</span><span class="n">RD0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="c1">// Inicia RD0 com o valor 0.</span>
    <span class="n">TRISDbits</span><span class="p">.</span><span class="n">TRISD0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="c1">// Configura RD0 como Saída.</span>
    <span class="n">TRISDbits</span><span class="p">.</span><span class="n">TRISD3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       <span class="c1">// Configura RD3 como Entrada;</span>
</code></pre></div></div>

<p>Note que o RD3 não é inicializado porque o dado vem de fora do uC, assim não faz sentido inicializá-lo pois não é um dado de saída.</p>

<p>O loop infinito possui o ciclo de execução que atende o objetivo proposto sendo estruturado da seguinte forma:</p>
<ul>
  <li>leitura do estado lógico no pino de entrada;</li>
  <li>ligar o LED se o estado lógico do pino é 1;</li>
  <li>desligar o LED se o estado lógico do pino é 0;</li>
</ul>

<p>Segue a codificação da estrutura do laço de repetição.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">while</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>                  <span class="c1">// Laço de repetição infinito.</span>
    <span class="p">{</span>                           <span class="c1">// Inicio do laço de repetição.</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">PORTDbits</span><span class="p">.</span><span class="n">RD3</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span><span class="c1">// Condição: Se o botão estiver pressionado.</span>
            <span class="n">PORTDbits</span><span class="p">.</span><span class="n">RD0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// Liga RD0.</span>
        <span class="k">else</span>                    <span class="c1">// Senão.</span>
            <span class="n">PORTDbits</span><span class="p">.</span><span class="n">RD0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// Desliga RD0.</span>
    <span class="p">}</span>                           <span class="c1">// Fim do laço de repetição.</span>
</code></pre></div></div>

<h2 id="utilizando-defines">Utilizando <code class="language-plaintext highlighter-rouge">defines</code></h2>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Botão com resistor de <em>pull-down</em></th>
      <th style="text-align: center">Botão com resistor de <em>pull-up</em></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="https://github.com/JoseWRPereira/ddp/blob/master//_posts/tUcPIC/imgP0102/P0102-botaoLED-pulldownres.gif?raw=true" alt="circuito" /></td>
      <td style="text-align: center"><img src="https://github.com/JoseWRPereira/ddp/blob/master//_posts/tUcPIC/imgP0102/P0102-botaoLED-pullupres.gif?raw=true" alt="circuito" /></td>
    </tr>
  </tbody>
</table>

<p>Agora é a sua vez!</p>

<p>Crie o seu projeto, copie o código, execute-o, procure os erros, arrume-os, seja resiliente, leia novamente a explicação, busque outras fontes, pergunte, responda, faça alterações conscientes no código, explore, divirta-se.</p>

<p>Ficou com alguma dúvida, entre em contato.</p>

<p>Bom trabalho!</p>

<p><a href="/ddp/docs/tecnology/ucPIC">Voltar</a></p>
:ET